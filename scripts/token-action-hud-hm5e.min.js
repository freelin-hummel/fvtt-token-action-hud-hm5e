const t={ID:"token-action-hud-hm5e"},e={ID:"token-action-hud-core"},i="1.5",n={item:"tokenActionHud.hm5e.item",weapon:"tokenActionHud.hm5e.weapon",armor:"tokenActionHud.hm5e.armor",spell:"tokenActionHud.hm5e.spell",skill:"tokenActionHud.hm5e.skill",ability:"tokenActionHud.hm5e.ability",utility:"tokenActionHud.utility"},s={weapons:{id:"weapons",name:"tokenActionHud.hm5e.weapons",type:"system"},armor:{id:"armor",name:"tokenActionHud.hm5e.armor",type:"system"},spells:{id:"spells",name:"tokenActionHud.hm5e.spells",type:"system"},skills:{id:"skills",name:"tokenActionHud.hm5e.skills",type:"system"},talents:{id:"talents",name:"tokenActionHud.hm5e.talents",type:"system"},proficiencies:{id:"proficiencies",name:"tokenActionHud.hm5e.proficiencies",type:"system"},items:{id:"items",name:"tokenActionHud.hm5e.items",type:"system"},abilities:{id:"abilities",name:"tokenActionHud.hm5e.abilities",type:"system"},combat:{id:"combat",name:"tokenActionHud.combat",type:"system"},token:{id:"token",name:"tokenActionHud.token",type:"system"},utility:{id:"utility",name:"tokenActionHud.utility",type:"system"}},o={armor:{groupId:"armor"},weapon:{groupId:"weapons"},spell:{groupId:"spells"},skill:{groupId:"skills"},talent:{groupId:"talents"},proficiency:{groupId:"proficiencies"},item:{groupId:"items"}};let a=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{a=class Utils{static getSetting(i,n=null){let s=n??null;try{s=game.settings.get(t.ID,i)}catch{e.api.Logger.debug(`Setting '${i}' not found`)}return s}static async setSetting(i,n){try{n=await game.settings.set(t.ID,i,n),e.api.Logger.debug(`Setting '${i}' set to '${n}'`)}catch{e.api.Logger.debug(`Setting '${i}' not found`)}}}}));let l=null;Hooks.once("tokenActionHudCoreApiReady",(async t=>{l=class ActionHandler extends t.api.ActionHandler{async buildSystemActions(e){if(this.actors=this.actor?[this.actor]:this._getActors(),this.actorType=this.actor?.type,this.displayUnequipped=a.getSetting("displayUnequipped"),this.actor){let e=this.actor.items;e=t.api.Utils.sortItemsByName(e),this.items=e}"character"===this.actorType||"beast"===this.actorType?this.#t():this.actor||this.#e()}#t(){this.#i(),this.#n()}#e(){}async#i(){if("character"!==this.actorType)return;const e="ability",i={id:"abilities",type:"system"},s=this.actor?.system?.abilities?.base;if(!s)return;const o=Object.entries(s).map((([i,s])=>{const o=i,a=i.toUpperCase(),l={text:s.value.toString()},c=t.api.Utils.i18n(n[e]),r=`${c?`${c}: `:""}${a}`,d=[e,o].join(this.delimiter);return{id:o,name:a,listName:r,encodedValue:d,info1:l}}));this.addActions(o,i)}async#n(){if(0===this.items.size)return;const e="item",i=new Map;for(const[t,e]of this.items){const n=e.type;if(e.equipped||this.displayUnequipped){const s=i.get(n)??new Map;s.set(t,e),i.set(n,s)}}for(const[s,a]of i){const i=o[s]?.groupId;if(!i)continue;const l={id:i,type:"system"},c=[...a].map((([i,s])=>{const o=i,a=s.name,l=t.api.Utils.i18n(n[e]),c=`${l?`${l}: `:""}${a}`,r=[e,o].join(this.delimiter);return{id:o,name:a,listName:c,encodedValue:r}}));this.addActions(c,l)}}}}));let c=null;Hooks.once("tokenActionHudCoreApiReady",(async t=>{const e=s;Object.values(e).forEach((e=>{e.name=t.api.Utils.i18n(e.name),e.listName=`Group: ${t.api.Utils.i18n(e.listName??e.name)}`}));const i=Object.values(e);c={layout:[{nestId:"abilities",id:"abilities",name:t.api.Utils.i18n("HM5E.Abilities"),groups:[{...e.abilities,nestId:"abilities_abilities"}]},{nestId:"inventory",id:"inventory",name:t.api.Utils.i18n("HM5E.Inventory"),groups:[{...e.weapons,nestId:"inventory_weapons"},{...e.armor,nestId:"inventory_armor"},{...e.spells,nestId:"inventory_spells"},{...e.skills,nestId:"inventory_skills"},{...e.talents,nestId:"inventory_talents"},{...e.proficiencies,nestId:"inventory_proficiencies"},{...e.items,nestId:"inventory_items"}]},{nestId:"utility",id:"utility",name:t.api.Utils.i18n("tokenActionHud.utility"),groups:[{...e.combat,nestId:"utility_combat"},{...e.token,nestId:"utility_token"},{...e.utility,nestId:"utility_utility"}]}],groups:i}}));let r=null;function register(e){game.settings.register(t.ID,"displayUnequipped",{name:game.i18n.localize("tokenActionHud.hm5e.settings.displayUnequipped.name"),hint:game.i18n.localize("tokenActionHud.hm5e.settings.displayUnequipped.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}Hooks.once("tokenActionHudCoreApiReady",(async t=>{r=class RollHandler extends t.api.RollHandler{async handleActionClick(t,e){const[i,n]=e.split("|");if(["item"].includes(i)&&this.isRenderItem())return this.doRenderItem(this.actor,n);const s=["character","beast"];if(this.actor)return void await this.#s(t,this.actor,this.token,i,n);const o=canvas.tokens.controlled.filter((t=>s.includes(t.actor?.type)));for(const e of o){const s=e.actor;await this.#s(t,s,e,i,n)}}async handleActionHover(t,e){}async handleGroupClick(t,e){}async#s(t,e,i,n,s){switch(n){case"item":case"weapon":case"armor":case"spell":case"skill":case"talent":case"proficiency":this.#o(t,e,s);break;case"ability":this.#a(t,e,s);break;case"utility":this.#l(i,s)}}#o(t,e,i){const n=e.items.get(i);n?.sheet&&n.sheet.render(!0)}#a(t,e,i){const n=e?.system?.abilities?.base;if(!n||!n[i])return;const s=n[i],o=i.toUpperCase(),a=s.value;ChatMessage.create({speaker:ChatMessage.getSpeaker({actor:e}),content:`<div class="hm5e-ability-roll">\n                    <h3>${o}</h3>\n                    <p><strong>Value:</strong> ${a}</p>\n                </div>`})}async#l(t,e){if("endTurn"===e)game.combat?.current?.tokenId===t.id&&await(game.combat?.nextTurn())}}}));let d=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{d=class SystemManager extends e.api.SystemManager{getActionHandler(){return new l}getAvailableRollHandlers(){return{core:"Core Hackmaster 5E"}}getRollHandler(t){let e;return e=new r,e}async registerDefaults(){return c}registerSettings(t){register(t)}registerStyles(){return{hm5e:{class:"tah-style-hm5e-style",file:"tah-hm5e-style",moduleId:t.ID,name:"Hackmaster 5E Style"}}}}})),Hooks.on("tokenActionHudCoreApiReady",(async()=>{const e=game.modules.get(t.ID);e.api={requiredCoreModuleVersion:"1.5",SystemManager:d},Hooks.call("tokenActionHudSystemReady",e)}));export{n as ACTION_TYPE,l as ActionHandler,e as CORE_MODULE,c as DEFAULTS,s as GROUP,o as ITEM_TYPE,t as MODULE,i as REQUIRED_CORE_MODULE_VERSION,r as RollHandler,d as SystemManager,a as Utils,register};
